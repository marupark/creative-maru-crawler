name: MAILNARA v6.0 ìš´ì˜ìš© ì‹œìŠ¤í…œ

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9:30 (í•œêµ­ì‹œê°„ ê¸°ì¤€ 0:30 UTC)
    - cron: '30 0 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - crawl-only
          - send-only

jobs:
  mailnara-v6:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        npm install
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
        
    - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸
      run: |
        echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
        echo "GMAIL_USER: ${{ secrets.GMAIL_USER != '' && 'ì„¤ì •ë¨' || 'ë¯¸ì„¤ì •' }}"
        echo "GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD != '' && 'ì„¤ì •ë¨' || 'ë¯¸ì„¤ì •' }}"
        echo "RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL != '' && 'ì„¤ì •ë¨' || 'ë¯¸ì„¤ì •' }}"
        
    - name: ğŸ•·ï¸ ì‹¤ì œ í¬ë¡¤ë§ ì‹¤í–‰
      if: ${{ github.event.inputs.mode != 'send-only' }}
      run: |
        echo "ğŸ” ì‹¤ì œ ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì‹œì‘..."
        node data-crawler.js
        echo "âœ… í¬ë¡¤ë§ ì™„ë£Œ"
        
    - name: ğŸ“„ JSON ë°ì´í„° í™•ì¸
      run: |
        echo "ğŸ“Š ìƒì„±ëœ ë°ì´í„° íŒŒì¼ í™•ì¸:"
        if [ -f "mailnara-data.json" ]; then
          echo "âœ… mailnara-data.json ì¡´ì¬"
          echo "ğŸ“ íŒŒì¼ í¬ê¸°: $(du -h mailnara-data.json)"
          echo "ğŸ“‹ í¬í•¨ ê³µê³  ìˆ˜: $(jq '.statistics.includedCount' mailnara-data.json)"
        else
          echo "âŒ mailnara-data.json ì—†ìŒ"
        fi
        
    - name: ğŸ“§ ìš´ì˜ìš© ë©”ì¼ ë°œì†¡
      if: ${{ github.event.inputs.mode != 'crawl-only' }}
      env:
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      run: |
        echo "ğŸ“§ ìš´ì˜ìš© ë©”ì¼ ë°œì†¡ ì‹œì‘..."
        node send-email-v6.js
        echo "âœ… ë©”ì¼ ë°œì†¡ ì™„ë£Œ"
        
    - name: ğŸ“ˆ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ“‹ MAILNARA v6.0 ì‹¤í–‰ ê²°ê³¼:"
        echo "ğŸ• ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ğŸ¯ ì‹¤í–‰ ëª¨ë“œ: ${{ github.event.inputs.mode || 'full' }}"
        if [ -f "mailnara-data.json" ]; then
          echo "ğŸ“Š ìˆ˜ì§‘ í†µê³„:"
          echo "  - ì´ ìˆ˜ì§‘: $(jq '.statistics.totalCrawled' mailnara-data.json)ê±´"
          echo "  - í¬í•¨: $(jq '.statistics.includedCount' mailnara-data.json)ê±´"
          echo "  - í‰ê· ì ìˆ˜: $(jq '.statistics.averageScore' mailnara-data.json)ì "
        fi
